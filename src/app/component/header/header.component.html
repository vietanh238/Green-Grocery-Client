<div class="header-wrapper">
  <p-menubar [model]="items" styleClass="custom-menubar">
    <ng-template #start>
      <div class="logo-container">
        <img src="assets/icon.png" alt="Logo" class="header-icon" />
      </div>
    </ng-template>
    <ng-template #end>
      <div class="header-actions">
        <button class="action-btn-hd search-btn" (click)="openSearch()" title="Tìm kiếm">
          <i class="pi pi-search"></i>
          <span class="action-text text-hidden">Tìm kiếm</span>
        </button>

        <div class="notification-wrapper">
          <p-overlaybadge
            [value]="countNotifications"
            [severity]="countNotifications > 9 ? 'danger' : 'success'"
          >
            <button
              class="action-btn-hd"
              (click)="openNotificationDrawer()"
              [class.shake]="bellShake"
              [class.bell-btn]="countNotifications > 0"
              title="Thông báo"
            >
              <i class="pi pi-bell"></i>
            </button>
          </p-overlaybadge>
        </div>

        <button class="action-btn-hd settings-btn" (click)="openSettings()" title="Cài đặt">
          <i class="pi pi-cog"></i>
          <span class="action-text text-hidden">Cài đặt</span>
        </button>

        <button class="action-btn-hd user-btn" (click)="navigateToPayOS()" title="Quản lý">
          <i class="pi pi-user"></i>
          <span class="action-text text-hidden">Quản lý</span>
        </button>
      </div>
    </ng-template>
  </p-menubar>
</div>

<!-- NOTIFICATION DRAWER -->
<p-drawer
  [(visible)]="notificationVisible"
  position="right"
  [style]="drawerStyle"
  [blockScroll]="true"
  [modal]="true"
  styleClass="notification-drawer"
>
  <ng-template #header>
    <div class="drawer-header">
      <h3 class="drawer-title text-hidden" *ngIf="!isHiddenIconBell">
        <i class="pi pi-bell"></i>
        Thông báo
      </h3>
      <div class="header-actions-drawer">
        <button
          class="mark-all-btn"
          (click)="markAllAsRead()"
          *ngIf="lstNotification.length > 0"
          title="Đánh dấu tất cả đã đọc"
        >
          <i class="pi pi-check-circle"></i>
          <span class="text-hidden">Đọc tất cả</span>
        </button>
        <button
          class="clear-all-btn"
          (click)="clearAllNotifications()"
          *ngIf="lstNotification.length > 0"
          title="Xóa tất cả"
        >
          <i class="pi pi-trash"></i>
        </button>
      </div>
    </div>
  </ng-template>

  <div class="notifications-container">
    <div *ngIf="lstNotification.length === 0" class="empty-state">
      <i class="pi pi-inbox empty-icon"></i>
      <p class="empty-text">Không có thông báo</p>
    </div>

    <div
      *ngFor="let item of lstNotification"
      class="notification-card"
      [class.unread]="!item.isRead"
      [style.background-color]="item.bg"
      [style.border-left-color]="item.color"
      (click)="onNotificationClick(item)"
    >
      <div class="notification-content">
        <h4 class="notification-title" [style.color]="item.color">
          {{ item.title }}
        </h4>
        <p class="notification-message">{{ item.message }}</p>
        <span class="notification-time">
          <i class="pi pi-clock"></i>
          {{ item.time_now }}
        </span>
      </div>

      <div class="notification-actions">
        <button
          class="action-icon"
          [class.read]="item.isRead"
          (click)="markAsRead(item, $event)"
          [title]="item.isRead ? 'Đã đọc' : 'Đánh dấu đã đọc'"
        >
          <i [class]="item.isRead ? 'pi pi-check-circle' : 'pi pi-circle'"></i>
        </button>
        <button
          class="action-icon delete"
          (click)="deleteNotification(item, $event)"
          title="Xóa thông báo"
        >
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>
  </div>
</p-drawer>

<!-- SETTINGS DIALOG - REDESIGNED -->
<p-dialog
  [(visible)]="settingsVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  styleClass="settings-dialog"
  header="Cài đặt"
  [style]="{ width: '550px', maxWidth: '95vw' }"
>
  <div class="settings-content">
    <!-- Thông tin tài khoản -->
    <div class="setting-group">
      <h4 class="group-title">
        <i class="pi pi-user"></i>
        Thông tin tài khoản
      </h4>
      <div class="setting-item info-item">
        <div class="setting-header">
          <label>Tên người dùng</label>
          <p class="setting-value">{{ userProfile.username || 'Chưa cập nhật' }}</p>
        </div>
      </div>
      <div class="setting-item info-item">
        <div class="setting-header">
          <label>Email</label>
          <p class="setting-value">{{ userProfile.email || 'Chưa cập nhật' }}</p>
        </div>
      </div>
      <div class="setting-item info-item">
        <div class="setting-header">
          <label>Số điện thoại</label>
          <p class="setting-value">{{ userProfile.phone || 'Chưa cập nhật' }}</p>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Giao diện -->
    <div class="setting-group">
      <h4 class="group-title">
        <i class="pi pi-palette"></i>
        Giao diện
      </h4>
      <div class="setting-item">
        <div class="setting-header">
          <label>Chế độ tối</label>
          <button
            class="toggle-btn"
            [class.active]="userSettings.darkMode"
            (click)="toggleDarkMode()"
            [title]="userSettings.darkMode ? 'Tắt chế độ tối' : 'Bật chế độ tối'"
          >
            <i
              class="pi"
              [class.pi-moon]="userSettings.darkMode"
              [class.pi-sun]="!userSettings.darkMode"
            ></i>
          </button>
        </div>
        <p class="setting-description">
          {{ userSettings.darkMode ? 'Đang sử dụng chế độ tối' : 'Đang sử dụng chế độ sáng' }}
        </p>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Thông báo -->
    <div class="setting-group">
      <h4 class="group-title">
        <i class="pi pi-bell"></i>
        Thông báo
      </h4>

      <div class="setting-item">
        <div class="setting-header">
          <label>Âm thanh thông báo</label>
          <button
            class="toggle-btn"
            [class.active]="userSettings.notificationSound"
            (click)="toggleNotificationSound()"
            [title]="userSettings.notificationSound ? 'Tắt âm thanh' : 'Bật âm thanh'"
          >
            <i
              class="pi"
              [class.pi-volume-up]="userSettings.notificationSound"
              [class.pi-volume-off]="!userSettings.notificationSound"
            ></i>
          </button>
        </div>
        <p class="setting-description">
          {{
            userSettings.notificationSound
              ? 'Phát âm thanh khi có thông báo mới'
              : 'Tắt âm thanh thông báo'
          }}
        </p>
      </div>

      <div class="setting-item">
        <div class="setting-header">
          <label>Thông báo desktop</label>
          <button
            class="toggle-btn"
            [class.active]="userSettings.desktopNotifications"
            (click)="toggleDesktopNotifications()"
            [title]="
              userSettings.desktopNotifications ? 'Tắt thông báo desktop' : 'Bật thông báo desktop'
            "
          >
            <i
              class="pi"
              [class.pi-desktop]="userSettings.desktopNotifications"
              [class.pi-times-circle]="!userSettings.desktopNotifications"
            ></i>
          </button>
        </div>
        <p class="setting-description">
          {{
            userSettings.desktopNotifications
              ? 'Hiển thị thông báo trên desktop'
              : 'Không hiển thị thông báo desktop'
          }}
        </p>
      </div>

      <div class="setting-item">
        <div class="setting-header">
          <label>Thông báo email</label>
          <button
            class="toggle-btn"
            [class.active]="userSettings.emailNotifications"
            (click)="toggleEmailNotifications()"
            [title]="
              userSettings.emailNotifications ? 'Tắt thông báo email' : 'Bật thông báo email'
            "
          >
            <i
              class="pi"
              [class.pi-envelope]="userSettings.emailNotifications"
              [class.pi-send]="!userSettings.emailNotifications"
            ></i>
          </button>
        </div>
        <p class="setting-description">
          {{
            userSettings.emailNotifications
              ? 'Nhận thông báo qua email'
              : 'Không nhận thông báo qua email'
          }}
        </p>
      </div>
    </div>
  </div>
</p-dialog>

<!-- SEARCH DIALOG - REDESIGNED -->
<p-dialog
  [(visible)]="searchVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  styleClass="search-dialog"
  [showHeader]="false"
  [style]="{ width: '650px', maxWidth: '95vw' }"
  (onHide)="onSearchDialogHide()"
>
  <div class="search-content">
    <!-- Search Header with Close Button -->
    <div class="search-header">
      <h3 class="search-header-title">
        <i class="pi pi-search"></i>
        Tìm kiếm nhanh
      </h3>
      <button class="close-dialog-btn" (click)="closeSearch()" title="Đóng">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Search Input -->
    <div class="search-input-wrapper">
      <i class="pi pi-search search-icon"></i>
      <input
        type="text"
        pInputText
        placeholder="Tìm kiếm sản phẩm, đơn hàng, khách hàng..."
        class="search-input"
        [(ngModel)]="searchQuery"
        (keyup.enter)="handleSearch()"
        (keyup.escape)="closeSearch()"
        #searchInput
      />
      <button class="clear-input" (click)="clearSearchInput()" *ngIf="searchQuery" title="Xóa">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Search Content Area -->
    <div class="search-content-area">
      <!-- Search History -->
      <div class="search-history" *ngIf="searchHistory.length > 0 && !searchQuery">
        <div class="history-header">
          <p class="suggestion-title">Tìm kiếm gần đây</p>
          <button class="clear-history-btn" (click)="clearSearchHistory()" title="Xóa lịch sử">
            <i class="pi pi-trash"></i>
            Xóa tất cả
          </button>
        </div>
        <div
          class="suggestion-item"
          *ngFor="let item of searchHistory.slice(0, 5)"
          (click)="selectFromHistory(item)"
        >
          <i class="pi pi-history"></i>
          <span>{{ item.query }}</span>
        </div>
      </div>

      <!-- Search Suggestions -->
      <div class="search-suggestions" *ngIf="!searchQuery && searchHistory.length === 0">
        <p class="suggestion-title">Gợi ý tìm kiếm</p>
        <div class="suggestion-item">
          <i class="pi pi-shopping-bag"></i>
          <span>Tìm sản phẩm theo tên hoặc SKU</span>
        </div>
        <div class="suggestion-item">
          <i class="pi pi-shopping-cart"></i>
          <span>Tìm đơn hàng theo mã số</span>
        </div>
        <div class="suggestion-item">
          <i class="pi pi-users"></i>
          <span>Tìm khách hàng theo tên hoặc SĐT</span>
        </div>
      </div>
    </div>
  </div>
</p-dialog>

<!-- Toast Notifications -->
<p-toast position="top-right" />
