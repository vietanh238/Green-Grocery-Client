<div class="products-page">
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">Quản lý sản phẩm</h1>
        <p class="page-subtitle">Theo dõi và quản lý tồn kho</p>
      </div>
      <div class="header-actions">
        <button class="btn-action btn-secondary" (click)="openSupplierDialog()">
          <i class="pi pi-building"></i>
          <span>Nhà cung cấp</span>
        </button>
        <button class="btn-action btn-secondary" (click)="openPurchaseOrderDialog()">
          <i class="pi pi-shopping-cart"></i>
          <span>Đặt hàng NCC</span>
        </button>
        <button class="btn-action btn-secondary" (click)="exportExcel()" [disabled]="exporting">
          <i class="pi" [class.pi-download]="!exporting" [class.pi-spin]="exporting" [class.pi-spinner]="exporting"></i>
          <span>{{ exporting ? 'Đang xuất...' : 'Xuất Excel' }}</span>
        </button>
        <button class="btn-action btn-secondary" (click)="openBulkImportDialog()">
          <i class="pi pi-upload"></i>
          <span>Nhập hàng</span>
        </button>
        <button class="btn-action btn-primary" (click)="openAddProductDialog()">
          <i class="pi pi-plus"></i>
          <span>Thêm sản phẩm</span>
        </button>
      </div>
    </div>
  </div>

  <div class="stats-overview">
    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="pi pi-box"></i>
      </div>
      <div class="stat-info">
        <span class="stat-label">Tổng sản phẩm</span>
        <span class="stat-value">{{ products?.length || 0 }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon yellow">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="stat-info">
        <span class="stat-label">Sắp hết hàng</span>
        <span class="stat-value">{{ reorderCount }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon red">
        <i class="pi pi-times-circle"></i>
      </div>
      <div class="stat-info">
        <span class="stat-label">Hết hàng</span>
        <span class="stat-value">{{ outOfStockCount }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="stat-info">
        <span class="stat-label">Tồn kho tốt</span>
        <span class="stat-value">{{ products.length - reorderCount - outOfStockCount || 0 }}</span>
      </div>
    </div>
  </div>

  <div class="content-section">
    <div class="filter-bar">
      <div class="search-wrapper">
        <i class="pi pi-search search-icon"></i>
        <input
          type="text"
          class="search-input"
          placeholder="Tìm kiếm sản phẩm, SKU, barcode..."
          [(ngModel)]="searchText"
          (input)="onSearch()"
        />
        <button *ngIf="searchText" class="clear-btn" (click)="clearSearch()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="filter-group">
        <p-select
          [options]="filterCategories"
          [(ngModel)]="selectedFilterCategory"
          optionLabel="name"
          placeholder="Phân loại"
          styleClass="filter-select"
          (onChange)="onFilterChange()"
          [showClear]="true"
        />

        <p-select
          [options]="stockFilters"
          [(ngModel)]="selectedStockFilter"
          optionLabel="name"
          placeholder="Tình trạng kho"
          styleClass="filter-select"
          (onChange)="onFilterChange()"
          [showClear]="true"
        />
      </div>
    </div>

    <div class="table-wrapper">
      <p-table
        [value]="filteredProducts"
        [rows]="15"
        [paginator]="true"
        [loading]="loading"
        [rowsPerPageOptions]="[15, 25, 50]"
        [scrollable]="true"
        scrollHeight="flex"
        responsiveLayout="scroll"
        styleClass="custom-table"
      >
        <ng-template #header>
          <tr>
            <th style="width: 50px">#</th>
            <th>Sản phẩm</th>
            <th style="width: 120px">SKU</th>
            <th style="width: 120px">Phân loại</th>
            <th style="width: 140px" class="text-right">Giá nhập</th>
            <th style="width: 140px" class="text-right">Giá bán</th>
            <th style="width: 100px" class="text-center">Tồn kho</th>
            <th style="width: 100px" class="text-center">Trạng thái</th>
            <th style="width: 120px" class="text-center">Thao tác</th>
          </tr>
        </ng-template>

        <ng-template #body let-product let-rowIndex="rowIndex">
          <tr [class]="getRowClass(product)">
            <td>{{ rowIndex + 1 }}</td>
            <td>
              <div class="product-info">
                <span class="product-name">{{ product.name }}</span>
                <span class="product-meta">{{ product.unit }}</span>
              </div>
            </td>
            <td>
              <span class="sku-badge">{{ product.sku }}</span>
            </td>
            <td>
              <span class="category-badge">{{ product.name_category }}</span>
            </td>
            <td class="text-right">
              <span class="price">{{ product.cost_price | number : '1.0-0' }} đ</span>
            </td>
            <td class="text-right">
              <span class="price primary">{{ product.price | number : '1.0-0' }} đ</span>
            </td>
            <td class="text-center">
              <span class="stock-badge" [class]="getStockClass(product)">
                {{ product.stock_quantity }}
              </span>
            </td>
            <td class="text-center">
              <span class="status-badge" [class]="getStockClass(product)">
                <i [class]="getStockIcon(product)"></i>
              </span>
            </td>
            <td class="text-center">
              <div class="action-buttons">
                <button class="btn-icon" (click)="viewDetail(product)" title="Chi tiết">
                  <i class="pi pi-eye"></i>
                </button>
                <button class="btn-icon" (click)="editProduct(product)" title="Sửa">
                  <i class="pi pi-pencil"></i>
                </button>
                <button class="btn-icon danger" (click)="confirmDelete(product)" title="Xóa">
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <i class="pi pi-inbox"></i>
                <p>Chưa có sản phẩm nào</p>
                <button class="btn-primary" (click)="openAddProductDialog()">
                  Thêm sản phẩm đầu tiên
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <p-toast position="top-right" />
</div>
