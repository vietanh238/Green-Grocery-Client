<div class="report-container" id="reportContent">
  <div class="page-header">
    <div class="header-left">
      <h2 class="page-title">
        <i class="pi pi-chart-bar"></i>
        Báo cáo kinh doanh
      </h2>
      <p class="page-subtitle">Phân tích và thống kê doanh thu, lợi nhuận</p>
    </div>
    <div class="header-actions">
      <button class="action-btn refresh-btn" (click)="refreshData()" [disabled]="loading">
        <i class="pi pi-refresh" [class.pi-spin]="loading"></i>
        <span>Làm mới</span>
      </button>
      <button class="action-btn print-btn" (click)="printReport()" [disabled]="loading">
        <i class="pi pi-print"></i>
        <span>In báo cáo</span>
      </button>
      <button class="action-btn export-btn" (click)="exportExcel()" [disabled]="loading || exporting">
        <i class="pi" [class.pi-file-excel]="!exporting" [class.pi-spin]="exporting" [class.pi-spinner]="exporting"></i>
        <span>{{ exporting ? 'Đang xuất...' : 'Xuất Excel' }}</span>
      </button>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-group">
      <label class="filter-label">Khoảng thời gian</label>
      <p-select
        [(ngModel)]="selectedPeriod"
        [options]="periodOptions"
        optionLabel="label"
        optionValue="value"
        (onChange)="onPeriodChange()"
        styleClass="period-select"
        placeholder="Chọn khoảng thời gian"
        [disabled]="loading"
      />
    </div>
    <div class="filter-group" *ngIf="showCustomDate">
      <label class="filter-label">Chọn ngày</label>
      <div class="date-input-group">
        <input type="date" [(ngModel)]="customDateFrom" class="date-input" placeholder="Từ ngày" [disabled]="loading" />
        <span class="date-separator">đến</span>
        <input
          type="date"
          [(ngModel)]="customDateTo"
          (change)="onDateRangeSelect()"
          class="date-input"
          placeholder="Đến ngày"
          [disabled]="loading"
        />
      </div>
    </div>
  </div>

  <div class="stats-grid" *ngIf="!loading">
    <div class="stat-card revenue">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="stat-trend" [class.up]="growth.revenue >= 0" [class.down]="growth.revenue < 0">
          <i [class]="growth.revenue >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(growth.revenue).toFixed(1) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng doanh thu</p>
        <h3 class="stat-value">{{ summary.totalRevenue | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">
          <span
            class="compare-value"
            [class.up]="growth.revenue >= 0"
            [class.down]="growth.revenue < 0"
          >
            {{ growth.revenue >= 0 ? '+' : '' }}{{ comparison.revenue | number : '1.0-0' }} đ
          </span>
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card profit">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="stat-trend" [class.up]="growth.profit >= 0" [class.down]="growth.profit < 0">
          <i [class]="growth.profit >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(growth.profit).toFixed(1) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng lợi nhuận</p>
        <h3 class="stat-value">{{ summary.totalProfit | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">
          <span
            class="compare-value"
            [class.up]="growth.profit >= 0"
            [class.down]="growth.profit < 0"
          >
            {{ growth.profit >= 0 ? '+' : '' }}{{ comparison.profit | number : '1.0-0' }} đ
          </span>
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card orders">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-shopping-cart"></i>
        </div>
        <div class="stat-trend" [class.up]="growth.order >= 0" [class.down]="growth.order < 0">
          <i [class]="growth.order >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(growth.order).toFixed(1) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng đơn hàng</p>
        <h3 class="stat-value">{{ summary.totalOrders }}</h3>
        <p class="stat-compare">
          <span class="compare-value" [class.up]="growth.order >= 0" [class.down]="growth.order < 0"
            >{{ comparison.order > 0 ? '+' : '' }}{{ comparison.order }} đơn</span
          >
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card margin">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-percentage"></i>
        </div>
        <div class="stat-trend" [class.up]="growth.margin >= 0" [class.down]="growth.margin < 0">
          <i [class]="growth.margin >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(growth.margin).toFixed(1) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tỷ suất lợi nhuận</p>
        <h3 class="stat-value">{{ summary.profitMargin.toFixed(1) }}%</h3>
        <p class="stat-compare">
          <span
            class="compare-value"
            [class.up]="growth.margin >= 0"
            [class.down]="growth.margin < 0"
          >
            {{ growth.margin >= 0 ? '+' : '' }}{{ growth.margin.toFixed(1) }}%
          </span>
          so với kỳ trước
        </p>
      </div>
    </div>
  </div>

  <div class="loading-state" *ngIf="loading">
    <i class="pi pi-spin pi-spinner"></i>
    <p>Đang tải báo cáo...</p>
  </div>

  <div class="charts-section" *ngIf="!loading">
    <div class="chart-wrapper">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-line"></i>
            Biểu đồ doanh thu theo tháng
          </h3>
        </div>
        <div class="chart-body">
          <p-chart
            type="line"
            [data]="revenueChartData"
            [options]="commonChartOptions"
            [style]="{ position: 'relative', height: '240px' }"
          />
        </div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-bar"></i>
            Lợi nhuận theo tháng
          </h3>
        </div>
        <div class="chart-body">
          <p-chart
            type="bar"
            [data]="profitChartData"
            [options]="commonChartOptions"
            [style]="{ position: 'relative', height: '220px' }"
          />
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-pie"></i>
            Top 5 sản phẩm bán chạy
          </h3>
        </div>
        <div class="chart-body">
          <p-chart
            type="doughnut"
            [data]="topProductsChartData"
            [options]="pieChartOptions"
            [style]="{ position: 'relative', height: '220px' }"
          />
        </div>
      </div>
    </div>
  </div>

  <p-tabs value="0" styleClass="custom-tabs" *ngIf="!loading">
    <p-tabpanel value="0">
      <ng-template #header>
        <div class="tab-header">
          <i class="pi pi-trophy"></i>
          <span>Sản phẩm bán chạy</span>
        </div>
      </ng-template>

      <div class="table-container">
        <p-table
          [value]="topProducts"
          [rows]="8"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} sản phẩm"
          [rowsPerPageOptions]="[8, 15, 25]"
          styleClass="products-table"
        >
          <ng-template #header>
            <tr>
              <th style="width: 50px">STT</th>
              <th>Tên sản phẩm</th>
              <th class="text-right">Số lượng bán</th>
              <th class="text-right">Doanh thu</th>
              <th class="text-center">Tỷ suất LN</th>
            </tr>
          </ng-template>
          <ng-template #body let-product let-rowIndex="rowIndex">
            <tr>
              <td>
                <div class="rank-badge" [class.top3]="rowIndex < 3">
                  <i class="pi" [class.pi-trophy]="rowIndex === 0" [class.pi-star]="rowIndex > 0 && rowIndex < 3"></i>
                  {{ rowIndex + 1 }}
                </div>
              </td>
              <td>
                <div class="product-info">
                  <strong class="product-name">{{ product.name }}</strong>
                  <span class="product-sku">SKU: {{ product.sku }}</span>
                </div>
              </td>
              <td class="text-right">
                <span class="quantity-value">{{ product.quantity }}</span>
              </td>
              <td class="text-right">
                <span class="revenue-value">{{ product.revenue | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-center">
                <p-tag
                  [value]="
                    (product.revenue > 0
                      ? (((product.revenue * 0.3) / product.revenue) * 100).toFixed(1)
                      : '0') + '%'
                  "
                  severity="success"
                />
              </td>
            </tr>
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="5" class="empty-message">
                <div class="empty-state">
                  <i class="pi pi-info-circle"></i>
                  <p>Chưa có dữ liệu sản phẩm</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>

    <p-tabpanel value="1">
      <ng-template #header>
        <div class="tab-header">
          <i class="pi pi-calendar"></i>
          <span>Chi tiết doanh thu</span>
        </div>
      </ng-template>

      <div class="table-container">
        <p-table
          [value]="monthlyRevenueData"
          [rows]="8"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} tháng"
          [rowsPerPageOptions]="[8, 15, 25]"
          styleClass="report-table"
        >
          <ng-template #header>
            <tr>
              <th>Tháng</th>
              <th class="text-right">Doanh thu</th>
              <th class="text-right">Số đơn hàng</th>
            </tr>
          </ng-template>
          <ng-template #body let-data>
            <tr>
              <td>
                <span class="date-value">{{ data.month }}</span>
              </td>
              <td class="text-right">
                <span class="revenue-value">{{ data.revenue | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-right">
                <span class="orders-value">{{ data.orders || '-' }}</span>
              </td>
            </tr>
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="3" class="empty-message">
                <div class="empty-state">
                  <i class="pi pi-info-circle"></i>
                  <p>Chưa có dữ liệu doanh thu</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>
  </p-tabs>

  <p-toast position="top-right" />
</div>
