<div class="report-container">
  <div class="page-header">
    <div class="header-left">
      <h2 class="page-title">
        <i class="pi pi-chart-bar"></i>
        Báo cáo kinh doanh
      </h2>
      <p class="page-subtitle">Phân tích và thống kê doanh thu, lợi nhuận</p>
    </div>
    <div class="header-actions">
      <button class="action-btn print-btn" (click)="printReport()">
        <i class="pi pi-print"></i>
        <span>In báo cáo</span>
      </button>
      <button class="action-btn export-btn" (click)="exportExcel()">
        <i class="pi pi-file-excel"></i>
        <span>Xuất Excel</span>
      </button>
      <button class="action-btn pdf-btn" (click)="exportPDF()">
        <i class="pi pi-file-pdf"></i>
        <span>Xuất PDF</span>
      </button>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-group">
      <label class="filter-label">Khoảng thời gian</label>
      <p-select
        [(ngModel)]="selectedPeriod"
        [options]="periodOptions"
        optionLabel="label"
        (onChange)="onPeriodChange()"
        styleClass="period-select"
      />
    </div>
    <div class="filter-group" *ngIf="showCustomDate">
      <label class="filter-label">Chọn ngày</label>
      <div class="date-input-group">
        <input type="date" [(ngModel)]="dateRange[0]" class="date-input" placeholder="Từ ngày" />
        <span class="date-separator">đến</span>
        <input
          type="date"
          [(ngModel)]="dateRange[1]"
          (change)="onDateRangeSelect()"
          class="date-input"
          placeholder="Đến ngày"
        />
      </div>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card revenue">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="stat-trend up">
          <i class="pi pi-arrow-up"></i>
          <span>18.5%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng doanh thu</p>
        <h3 class="stat-value">{{ totalRevenue | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">
          <span class="compare-value up">+42.5M đ</span>
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card profit">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="stat-trend up">
          <i class="pi pi-arrow-up"></i>
          <span>22.3%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng lợi nhuận</p>
        <h3 class="stat-value">{{ totalProfit | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">
          <span class="compare-value up">+14.3M đ</span>
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card orders">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-shopping-cart"></i>
        </div>
        <div class="stat-trend up">
          <i class="pi pi-arrow-up"></i>
          <span>12.8%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tổng đơn hàng</p>
        <h3 class="stat-value">{{ totalOrders }}</h3>
        <p class="stat-compare">
          <span class="compare-value up">+98 đơn</span>
          so với kỳ trước
        </p>
      </div>
    </div>

    <div class="stat-card margin">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-percentage"></i>
        </div>
        <div class="stat-trend up">
          <i class="pi pi-arrow-up"></i>
          <span>3.2%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Tỷ suất lợi nhuận</p>
        <h3 class="stat-value">{{ profitMargin }}%</h3>
        <p class="stat-compare">
          <span class="compare-value up">+0.8%</span>
          so với kỳ trước
        </p>
      </div>
    </div>
  </div>

  <div class="charts-section">
    <div class="chart-row">
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-line"></i>
            Biểu đồ doanh thu theo tháng
          </h3>
        </div>
        <div class="chart-body">
          <p-chart type="line" [data]="revenueChartData" [options]="revenueChartOptions" />
        </div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-card half-width">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-bar"></i>
            Lợi nhuận theo tháng
          </h3>
        </div>
        <div class="chart-body">
          <p-chart type="bar" [data]="profitChartData" [options]="profitChartOptions" />
        </div>
      </div>

      <div class="chart-card half-width">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-pie"></i>
            Phân bổ theo danh mục
          </h3>
        </div>
        <div class="chart-body">
          <p-chart type="pie" [data]="categoryChartData" [options]="categoryChartOptions" />
        </div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="pi pi-chart-bar"></i>
            So sánh tháng này với tháng trước
          </h3>
        </div>
        <div class="chart-body">
          <p-chart type="bar" [data]="comparisonChartData" [options]="comparisonChartOptions" />
        </div>
      </div>
    </div>
  </div>

  <p-tabs value="0" styleClass="custom-tabs">
    <p-tabpanel value="0">
      <ng-template #header>
        <div class="tab-header">
          <i class="pi pi-calendar"></i>
          <span>Báo cáo theo ngày</span>
        </div>
      </ng-template>

      <div class="table-container">
        <p-table
          [value]="reportData"
          [rows]="10"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} bản ghi"
          [rowsPerPageOptions]="[10, 25, 50]"
          styleClass="report-table"
        >
          <ng-template #header>
            <tr>
              <th>Ngày</th>
              <th class="text-right">Doanh thu</th>
              <th class="text-right">Chi phí</th>
              <th class="text-right">Lợi nhuận</th>
              <th class="text-right">Số đơn</th>
              <th class="text-center">Tỷ suất LN</th>
            </tr>
          </ng-template>
          <ng-template #body let-report>
            <tr>
              <td>
                <span class="date-value">{{ report.period }}</span>
              </td>
              <td class="text-right">
                <span class="revenue-value">{{ report.revenue | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-right">
                <span class="cost-value">{{ report.cost | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-right">
                <span class="profit-value">{{ report.profit | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-right">
                <span class="orders-value">{{ report.orders }}</span>
              </td>
              <td class="text-center">
                <p-tag
                  [value]="calculateProfitMargin(report.revenue, report.profit).toFixed(1) + '%'"
                />
              </td>
            </tr>
          </ng-template>
          <ng-template #summary>
            <tr class="summary-row">
              <td><strong>Tổng cộng</strong></td>
              <td class="text-right">
                <strong class="revenue-value">45,800,000 đ</strong>
              </td>
              <td class="text-right">
                <strong class="cost-value">33,100,000 đ</strong>
              </td>
              <td class="text-right">
                <strong class="profit-value">12,700,000 đ</strong>
              </td>
              <td class="text-right">
                <strong>136</strong>
              </td>
              <td class="text-center">
                <strong>27.7%</strong>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>

    <p-tabpanel value="1">
      <ng-template #header>
        <div class="tab-header">
          <i class="pi pi-star-fill"></i>
          <span>Sản phẩm bán chạy</span>
        </div>
      </ng-template>

      <div class="table-container">
        <p-table
          [value]="topProducts"
          [rows]="10"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} sản phẩm"
          [rowsPerPageOptions]="[10, 25, 50]"
          styleClass="products-table"
        >
          <ng-template #header>
            <tr>
              <th>STT</th>
              <th>Tên sản phẩm</th>
              <th class="text-right">Số lượng bán</th>
              <th class="text-right">Doanh thu</th>
              <th class="text-right">Lợi nhuận</th>
              <th class="text-center">Tỷ suất LN</th>
            </tr>
          </ng-template>
          <ng-template #body let-product let-rowIndex="rowIndex">
            <tr>
              <td>
                <div class="rank-badge" [class.top3]="rowIndex < 3">
                  {{ rowIndex + 1 }}
                </div>
              </td>
              <td>
                <strong class="product-name">{{ product.name }}</strong>
              </td>
              <td class="text-right">
                <span class="quantity-value">{{ product.quantity }}</span>
              </td>
              <td class="text-right">
                <span class="revenue-value">{{ product.revenue | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-right">
                <span class="profit-value">{{ product.profit | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-center">
                <p-tag
                  [value]="calculateProfitMargin(product.revenue, product.profit).toFixed(1) + '%'"
                />
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>

    <p-tabpanel value="2">
      <ng-template #header>
        <div class="tab-header">
          <i class="pi pi-th-large"></i>
          <span>Báo cáo theo danh mục</span>
        </div>
      </ng-template>

      <div class="table-container">
        <p-table
          [value]="categoryData"
          [rows]="10"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} danh mục"
          styleClass="category-table"
        >
          <ng-template #header>
            <tr>
              <th>Danh mục</th>
              <th class="text-right">Doanh thu</th>
              <th class="text-center">Tỷ trọng</th>
              <th class="text-center">Biểu đồ</th>
            </tr>
          </ng-template>
          <ng-template #body let-category>
            <tr>
              <td>
                <strong class="category-name">{{ category.category }}</strong>
              </td>
              <td class="text-right">
                <span class="revenue-value">{{ category.revenue | number : '1.0-0' }} đ</span>
              </td>
              <td class="text-center">
                <span class="percentage-badge">{{ category.percentage }}%</span>
              </td>
              <td>
                <div class="progress-bar-container">
                  <div class="progress-bar" [style.width.%]="category.percentage">
                    <span class="progress-text">{{ category.percentage }}%</span>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template #summary>
            <tr class="summary-row">
              <td><strong>Tổng cộng</strong></td>
              <td class="text-right">
                <strong class="revenue-value">285,000,000 đ</strong>
              </td>
              <td class="text-center">
                <strong>100%</strong>
              </td>
              <td></td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-tabpanel>
  </p-tabs>

  <div class="insights-section">
    <h3 class="section-title">
      <i class="pi pi-lightbulb"></i>
      Thông tin chi tiết
    </h3>
    <div class="insights-grid">
      <div class="insight-card positive">
        <div class="insight-icon">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="insight-content">
          <h4 class="insight-title">Doanh thu tăng</h4>
          <p class="insight-text">
            Doanh thu tháng này tăng 18.5% so với tháng trước, đạt 285 triệu đồng
          </p>
          <span class="insight-value">+42.5M đ</span>
        </div>
      </div>

      <div class="insight-card positive">
        <div class="insight-icon">
          <i class="pi pi-arrow-up"></i>
        </div>
        <div class="insight-content">
          <h4 class="insight-title">Lợi nhuận ổn định</h4>
          <p class="insight-text">Tỷ suất lợi nhuận 27.5%, tăng 3.2% so với kỳ trước</p>
          <span class="insight-value">78.5M đ</span>
        </div>
      </div>

      <div class="insight-card info">
        <div class="insight-icon">
          <i class="pi pi-star-fill"></i>
        </div>
        <div class="insight-content">
          <h4 class="insight-title">Sản phẩm bán chạy</h4>
          <p class="insight-text">Gạo ST25 5kg dẫn đầu với 125 sản phẩm đã bán</p>
          <span class="insight-value">18.75M đ</span>
        </div>
      </div>

      <div class="insight-card warning">
        <div class="insight-icon">
          <i class="pi pi-exclamation-triangle"></i>
        </div>
        <div class="insight-content">
          <h4 class="insight-title">Hàng cần chú ý</h4>
          <p class="insight-text">Danh mục "Khác" chỉ đạt 6.8% tỷ trọng, cần xem xét bổ sung</p>
          <span class="insight-value">19.25M đ</span>
        </div>
      </div>
    </div>
  </div>
</div>

<p-toast position="top-right" />
