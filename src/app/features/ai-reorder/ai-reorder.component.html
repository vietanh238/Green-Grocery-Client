<div class="ai-reorder-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h2 class="page-title">
          <i class="pi pi-bolt"></i>
          AI Dự Đoán Nhập Hàng
        </h2>
        <p class="page-subtitle">Hệ thống phân tích tồn kho & đề xuất nhập hàng tự động</p>
      </div>
      <div class="header-actions">
        <button
          class="action-btn create-order-btn"
          (click)="createBulkOrder()"
          [disabled]="selectedProducts.length === 0"
        >
          <i class="pi pi-shopping-cart"></i>
          <span>Tạo đơn ({{ selectedProducts.length }})</span>
        </button>

        <button class="action-btn export-btn" (click)="exportExcel()" [disabled]="loading">
          <i class="pi pi-file-excel"></i>
          <span>Xuất Excel</span>
        </button>

        <button class="action-btn train-btn" (click)="trainAI()" [disabled]="trainingAI || loading">
          <i class="pi" [class.pi-sync]="!trainingAI" [class.pi-spin]="trainingAI"></i>
          <span>{{ trainingAI ? 'Đang train...' : 'Train Model' }}</span>
        </button>

        <button
          class="action-btn refresh-btn"
          (click)="loadRecommendations()"
          [disabled]="loading"
          title="Làm mới"
        >
          <i class="pi pi-refresh" [class.pi-spin]="loading"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="summary-section">
    <div class="summary-card total">
      <div class="card-icon"><i class="pi pi-box"></i></div>
      <div class="card-content">
        <span class="card-label">Cần nhập</span>
        <span class="card-value">{{ summary.total_products_need_reorder }}</span>
        <span class="card-subtitle">sản phẩm</span>
      </div>
    </div>

    <div class="summary-card critical" *ngIf="summary.critical_urgency > 0">
      <div class="card-icon"><i class="pi pi-exclamation-circle"></i></div>
      <div class="card-content">
        <span class="card-label">Rất khẩn cấp</span>
        <span class="card-value">{{ summary.critical_urgency }}</span>
        <span class="card-subtitle">cần xử lý ngay</span>
      </div>
    </div>

    <div class="summary-card urgent">
      <div class="card-icon"><i class="pi pi-exclamation-triangle"></i></div>
      <div class="card-content">
        <span class="card-label">Khẩn cấp</span>
        <span class="card-value">{{ summary.high_urgency }}</span>
        <span class="card-subtitle">hết hàng < 3 ngày</span>
      </div>
    </div>

    <div class="summary-card medium">
      <div class="card-icon"><i class="pi pi-clock"></i></div>
      <div class="card-content">
        <span class="card-label">Trung bình</span>
        <span class="card-value">{{ summary.medium_urgency }}</span>
        <span class="card-subtitle">hết hàng < 7 ngày</span>
      </div>
    </div>

    <div class="summary-card cost">
      <div class="card-icon"><i class="pi pi-wallet"></i></div>
      <div class="card-content">
        <span class="card-label">Tổng vốn dự kiến</span>
        <span class="card-value">{{ summary.total_estimated_cost | number : '1.0-0' }} đ</span>
        <span class="card-subtitle">cho tất cả đề xuất</span>
      </div>
    </div>
  </div>

  <div class="analytics-grid">
    <div class="chart-card">
      <div class="card-title">
        <span>Phân bổ độ ưu tiên</span>
        <i class="pi pi-chart-pie text-gray-400"></i>
      </div>
      <div class="chart-container">
        <p-chart
          type="doughnut"
          [data]="chartData"
          [options]="chartOptions"
          [style]="{ height: '100%', width: '100%', maxHeight: '100%' }"
        ></p-chart>
      </div>
    </div>

    <div class="info-card">
      <div class="card-title">
        <span>Thông tin Model AI</span>
        <i class="pi pi-cog text-gray-400"></i>
      </div>
      <div class="info-list">
        <div class="info-item">
          <div class="info-icon"><i class="pi pi-sitemap"></i></div>
          <div class="info-details">
            <strong>Thuật toán</strong>
            <span>Random Forest (100 Trees)</span>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="pi pi-history"></i></div>
          <div class="info-details">
            <strong>Dữ liệu học</strong>
            <span>60 ngày gần nhất</span>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="pi pi-calendar-plus"></i></div>
          <div class="info-details">
            <strong>Chu kỳ dự báo</strong>
            <span>30 ngày tiếp theo</span>
          </div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="pi pi-shield"></i></div>
          <div class="info-details">
            <strong>Safety Stock</strong>
            <span>3 ngày an toàn</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <div class="table-header">
      <div class="search-box">
        <i class="pi pi-search"></i>
        <input
          type="text"
          placeholder="Tìm tên sản phẩm, SKU..."
          [(ngModel)]="searchText"
          (input)="onSearch()"
        />
      </div>

      <div class="filter-box">
        <p-select
          [options]="urgencyFilters"
          [(ngModel)]="selectedUrgency"
          optionLabel="label"
          optionValue="value"
          placeholder="Lọc theo độ ưu tiên"
          (onChange)="onFilterChange()"
          [showClear]="true"
        ></p-select>
      </div>
    </div>

    <p-table
      [value]="filteredRecommendations"
      [rows]="50"
      [paginator]="true"
      [rowsPerPageOptions]="[20, 50, 100]"
      [loading]="loading"
      [scrollable]="true"
      scrollHeight="flex"
      [(selection)]="selectedProducts"
      selectionMode="multiple"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 40px">
            <p-checkbox
              [(ngModel)]="selectAll"
              (onChange)="onSelectAllChange()"
              [binary]="true"
            ></p-checkbox>
          </th>
          <th style="width: 50px">STT</th>
          <th style="width: 250px">Sản phẩm</th>
          <th style="width: 120px">Độ ưu tiên</th>
          <th style="width: 100px" class="text-center">Tồn kho</th>
          <th style="width: 100px" class="text-center">Hết sau</th>
          <th style="width: 100px" class="text-right">Nhu cầu 30d</th>
          <th style="width: 120px" class="text-right">Đề xuất nhập</th>
          <th style="width: 130px" class="text-right">Chi phí</th>
          <th style="width: 60px" class="text-center">#</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
        <tr [class.selected-row]="isSelected(item)">
          <td>
            <p-checkbox
              [(ngModel)]="item.selected"
              (onChange)="onRowSelect(item)"
              [binary]="true"
            ></p-checkbox>
          </td>
          <td>{{ rowIndex + 1 }}</td>
          <td>
            <div class="product-cell">
              <span class="name" [title]="item.product_name">{{ item.product_name }}</span>
              <span class="sku">{{ item.product_sku }}</span>
            </div>
          </td>
          <td>
            <p-tag
              [value]="getUrgencyLabel(item.urgency)"
              [severity]="getUrgencySeverity(item.urgency)"
              [rounded]="true"
            ></p-tag>
          </td>
          <td class="text-center">
            <span class="stock-badge" [ngClass]="(item.days_until_stockout !== null && item.days_until_stockout !== undefined && item.days_until_stockout < 999 && item.days_until_stockout <= 3) ? 'low' : 'ok'">
              {{ item.current_stock }}
            </span>
          </td>
          <td class="text-center">
            <span
              *ngIf="item.days_until_stockout !== null && item.days_until_stockout !== undefined && item.days_until_stockout < 999"
              [style.color]="item.days_until_stockout <= 3 ? '#ef4444' : item.days_until_stockout <= 7 ? '#f59e0b' : 'inherit'"
              style="font-weight: 600"
            >
              {{ item.days_until_stockout }} ngày
            </span>
            <span
              *ngIf="item.days_until_stockout === null || item.days_until_stockout === undefined || item.days_until_stockout >= 999"
              style="color: #10b981; font-weight: 600"
              title="Không có nhu cầu hoặc tồn kho đủ dùng lâu dài"
            >
              Không hết
            </span>
          </td>
          <td class="text-right">{{ item.predicted_demand_30_days | number : '1.0-0' }}</td>
          <td class="text-right font-bold text-green-600">
            {{ item.optimal_order_quantity | number : '1.0-0' }}
          </td>
          <td class="text-right">{{ item.estimated_cost | number : '1.0-0' }} đ</td>
          <td class="text-center">
            <button class="action-icon-btn" (click)="viewForecast(item)" title="Xem chi tiết">
              <i class="pi pi-chart-line"></i>
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center p-5">
            <div class="flex flex-column align-items-center gap-3">
              <i class="pi pi-check-circle text-5xl text-green-500"></i>
              <span class="font-bold text-xl">Không có đề xuất nhập hàng nào!</span>
              <span class="text-gray-500">Tồn kho hiện tại vẫn đủ đáp ứng nhu cầu sắp tới.</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  <p-toast />
</div>
