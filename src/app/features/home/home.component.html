<div class="home-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h2 class="page-title">
          <i class="pi pi-home"></i>
          Dashboard
        </h2>
        <p class="page-subtitle">Tổng quan hoạt động kinh doanh hôm nay</p>
      </div>
      <div class="header-actions">
        <p-select
          [(ngModel)]="selectedPeriod"
          [options]="periodOptions"
          optionLabel="label"
          optionValue="value"
          (onChange)="onPeriodChange()"
          styleClass="period-select"
          placeholder="Chọn khoảng thời gian"
        />
        <button class="action-btn refresh-btn" (click)="refreshData()" [disabled]="loading">
          <i
            class="pi"
            [class.pi-refresh]="!loading"
            [class.pi-spin]="loading"
            [class.loading]="loading"
          ></i>
        </button>
        <button class="action-btn export-btn" (click)="exportReport()" [disabled]="exporting">
          <i class="pi" [class.pi-file-excel]="!exporting" [class.pi-spin]="exporting" [class.pi-spinner]="exporting"></i>
          <span>{{ exporting ? 'Đang xuất...' : 'Xuất Excel' }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner-container">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Đang tải dữ liệu...</p>
    </div>
  </div>

  <div class="stats-grid" *ngIf="!loading">
    <div class="stat-card revenue">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="stat-trend" [class.up]="revenueGrowth >= 0" [class.down]="revenueGrowth < 0">
          <i [class]="revenueGrowth >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(revenueGrowth) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Doanh thu</p>
        <h3 class="stat-value">{{ todayRevenue | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">
          <span [class.positive]="revenueComparison >= 0" [class.negative]="revenueComparison < 0">
            {{ revenueComparison >= 0 ? '+' : '' }}{{ revenueComparison | number : '1.0-0' }} đ
          </span>
          so với {{ comparisonPeriod }}
        </p>
      </div>
    </div>

    <div class="stat-card orders">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-shopping-cart"></i>
        </div>
        <div class="stat-trend" [class.up]="orderGrowth >= 0" [class.down]="orderGrowth < 0">
          <i [class]="orderGrowth >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(orderGrowth) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Đơn hàng</p>
        <h3 class="stat-value">{{ todayOrders }}</h3>
        <p class="stat-compare">
          <span [class.positive]="orderComparison >= 0" [class.negative]="orderComparison < 0">
            {{ orderComparison >= 0 ? '+' : '' }}{{ orderComparison }}
          </span>
          so với {{ comparisonPeriod }}
        </p>
      </div>
    </div>

    <div class="stat-card profit">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="stat-trend" [class.up]="profitGrowth >= 0" [class.down]="profitGrowth < 0">
          <i [class]="profitGrowth >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(profitGrowth) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Lợi nhuận</p>
        <h3 class="stat-value">{{ todayProfit | number : '1.0-0' }} đ</h3>
        <p class="stat-compare">Tỷ suất: {{ profitMargin.toFixed(1) }}%</p>
      </div>
    </div>

    <div class="stat-card customers">
      <div class="stat-header">
        <div class="stat-icon">
          <i class="pi pi-users"></i>
        </div>
        <div class="stat-trend" [class.up]="customerGrowth >= 0" [class.down]="customerGrowth < 0">
          <i [class]="customerGrowth >= 0 ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
          <span>{{ Math.abs(customerGrowth) }}%</span>
        </div>
      </div>
      <div class="stat-body">
        <p class="stat-label">Khách hàng</p>
        <h3 class="stat-value">{{ todayCustomers }}</h3>
        <p class="stat-compare">Khách mới: {{ newCustomers }} người</p>
      </div>
    </div>
  </div>

  <div class="charts-wrapper" *ngIf="!loading">
    <div class="chart-card revenue-chart">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="pi pi-chart-line"></i>
          Biểu đồ doanh thu
        </h3>
      </div>
      <div class="chart-body">
        <p-chart
          type="line"
          [data]="revenueChartData"
          [options]="revenueChartOptions"
          [style]="{ position: 'relative', height: '320px', width: '100%' }"
        />
      </div>
    </div>

    <div class="chart-card category-chart">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="pi pi-chart-pie"></i>
          Doanh thu theo danh mục
        </h3>
      </div>
      <div class="chart-body">
        <p-chart
          type="doughnut"
          [data]="categoryChartData"
          [options]="pieChartOptions"
          [style]="{ position: 'relative', height: '320px' }"
        />
      </div>
    </div>
  </div>

  <!-- Inventory Overview Stats (Optional - can add to stats-grid if needed) -->
  <div class="inventory-overview" *ngIf="!loading && inventoryStats">
    <div class="inventory-card">
      <div class="inventory-header">
        <div class="header-left">
          <h3 class="inventory-title">
            <i class="pi pi-box"></i>
            Tổng quan kho hàng
          </h3>
          <p class="inventory-subtitle">Theo dõi tình trạng tồn kho</p>
        </div>
        <div class="header-right">
          <button class="view-inventory-btn" (click)="viewAllInventory()">
            Xem tất cả
            <i class="pi pi-arrow-right"></i>
          </button>
        </div>
      </div>
      <div class="inventory-stats-grid">
        <div class="inv-stat-item">
          <div class="inv-stat-icon total">
            <i class="pi pi-database"></i>
          </div>
          <div class="inv-stat-content">
            <p class="inv-stat-label">Tổng sản phẩm</p>
            <h4 class="inv-stat-value">{{ inventoryStats.total_products }}</h4>
          </div>
        </div>
        <div class="inv-stat-item">
          <div class="inv-stat-icon warning">
            <i class="pi pi-exclamation-circle"></i>
          </div>
          <div class="inv-stat-content">
            <p class="inv-stat-label">Sắp hết hàng</p>
            <h4 class="inv-stat-value">{{ inventoryStats.low_stock_count }}</h4>
          </div>
        </div>
        <div class="inv-stat-item">
          <div class="inv-stat-icon danger">
            <i class="pi pi-times-circle"></i>
          </div>
          <div class="inv-stat-content">
            <p class="inv-stat-label">Hết hàng</p>
            <h4 class="inv-stat-value">{{ inventoryStats.out_of_stock_count }}</h4>
          </div>
        </div>
        <div class="inv-stat-item">
          <div class="inv-stat-icon success">
            <i class="pi pi-dollar"></i>
          </div>
          <div class="inv-stat-content">
            <p class="inv-stat-label">Giá trị tồn kho</p>
            <h4 class="inv-stat-value">
              {{ inventoryStats.total_stock_value | number : '1.0-0' }} đ
            </h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="data-grid" *ngIf="!loading">
    <div class="data-section recent-sales-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="pi pi-clock"></i>
          Đơn hàng gần đây
        </h3>
        <button class="view-all-btn" (click)="viewAllSales()">
          Xem tất cả
          <i class="pi pi-arrow-right"></i>
        </button>
      </div>
      <div class="table-wrapper">
        <p-table [value]="recentSales" [rows]="5" styleClass="sales-table">
          <ng-template #header>
            <tr>
              <th style="width: 100px">Mã đơn</th>
              <th style="width: 80px">Thời gian</th>
              <th>Khách hàng</th>
              <th class="text-right" style="width: 120px">Số tiền</th>
              <th style="width: 110px">Thanh toán</th>
              <th class="text-center" style="width: 100px">Trạng thái</th>
            </tr>
          </ng-template>
          <ng-template #body let-sale>
            <tr>
              <td>
                <span class="order-id">{{ sale.order_code }}</span>
              </td>
              <td>
                <span class="time">{{ sale.created_at | date : 'HH:mm' }}</span>
              </td>
              <td>
                <span class="customer-name">{{ sale.buyer_name || 'Khách lẻ' }}</span>
              </td>
              <td class="text-right">
                <span class="amount">{{ sale.amount | number : '1.0-0' }} đ</span>
              </td>
              <td>
                <span class="payment-method">{{ getPaymentMethod(sale.status) }}</span>
              </td>
              <td class="text-center text-hidden">
                <p-tag
                  [value]="getStatusLabel(sale.status)"
                  [severity]="getStatusSeverity(sale.status)"
                />
              </td>
            </tr>
          </ng-template>
          <ng-template #emptymessage>
            <tr>
              <td colspan="6" class="empty-message-cell">
                <div class="empty-state-inline">
                  <i class="pi pi-inbox"></i>
                  <p>Chưa có đơn hàng nào</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <div class="data-section-container">
      <div class="data-section top-products">
        <div class="section-header">
          <h3 class="section-title">
            <i class="pi pi-star-fill"></i>
            Sản phẩm bán chạy
          </h3>
          <button class="view-all-btn" (click)="viewAllProducts()">
            Xem tất cả
            <i class="pi pi-arrow-right"></i>
          </button>
        </div>
        <div class="products-list">
          <div class="product-item" *ngFor="let product of topProducts; let i = index">
            <div class="product-rank" [class.top3]="i < 3">{{ i + 1 }}</div>
            <div class="product-info">
              <h4 class="product-name">{{ product.name }}</h4>
              <div class="product-stats">
                <span class="quantity">
                  <i class="pi pi-box"></i>
                  {{ product.quantity }} đã bán
                </span>
                <span class="revenue">{{ product.revenue | number : '1.0-0' }} đ</span>
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="!topProducts || topProducts.length === 0">
            <i class="pi pi-star"></i>
            <p>Chưa có dữ liệu</p>
          </div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="data-section activity-timeline" *ngIf="recentActivities.length > 0">
        <div class="section-header">
          <h3 class="section-title">
            <i class="pi pi-bell"></i>
            Hoạt động gần đây
          </h3>
        </div>
        <div class="timeline-list">
          <div class="timeline-item" *ngFor="let activity of recentActivities">
            <div class="timeline-marker" [style.background]="activity.color">
              <i class="pi" [ngClass]="activity.icon"></i>
            </div>
            <div class="timeline-content">
              <h4 class="activity-title">{{ activity.title }}</h4>
              <p class="activity-description">{{ activity.description }}</p>
              <span class="activity-time">{{ activity.time }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Low Stock Alerts -->
  <div class="alerts-section" *ngIf="!loading && lowStockProducts && lowStockProducts.length > 0">
    <div class="alerts-header">
      <h3 class="section-title">
        <i class="pi pi-exclamation-triangle"></i>
        Cảnh báo tồn kho
      </h3>
      <p class="alerts-subtitle">Sản phẩm cần nhập thêm</p>
    </div>
    <div class="alerts-grid">
      <div
        class="alert-card"
        *ngFor="let product of lowStockProducts"
        [class.critical]="product.urgency === 'critical'"
        [class.high]="product.urgency === 'high'"
        [class.medium]="product.urgency === 'medium'"
        (click)="viewProduct(product.id)"
      >
        <div class="alert-indicator" [class]="product.urgency"></div>
        <div class="alert-content">
          <div class="alert-header">
            <div class="alert-title-group">
              <h4 class="alert-product-name">{{ product.name }}</h4>
              <p class="alert-sku">SKU: {{ product.sku }}</p>
            </div>
            <p-tag
              [value]="getUrgencyLabel(product.urgency)"
              [severity]="getUrgencySeverity(product.urgency)"
            />
          </div>
          <div class="alert-details">
            <div class="detail-item">
              <i class="pi pi-box"></i>
              <span
                >Tồn kho: <strong>{{ product.stock_quantity }} {{ product.unit }}</strong></span
              >
            </div>
            <div class="detail-item">
              <i class="pi pi-flag"></i>
              <span
                >Điểm đặt lại: <strong>{{ product.reorder_point }} {{ product.unit }}</strong></span
              >
            </div>
            <div class="detail-item">
              <i class="pi pi-tag"></i>
              <span><strong>{{ product.category }}</strong></span>
            </div>
          </div>
          <div class="alert-status">
            <i
              class="pi"
              [class.pi-times-circle]="product.status === 'out_of_stock'"
              [class.pi-exclamation-triangle]="product.status === 'low_stock'"
            ></i>
            <span>{{
              product.status === 'out_of_stock' ? 'Hết hàng' : 'Sắp hết hàng'
            }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="quick-actions">
    <h3 class="section-title">
      <i class="pi pi-bolt"></i>
      Thao tác nhanh
    </h3>
    <div class="actions-grid">
      <button class="quick-action-btn" (click)="navigateTo('/page/sell')">
        <i class="pi pi-plus-circle"></i>
        <span>Tạo đơn hàng</span>
      </button>
      <button class="quick-action-btn" (click)="navigateTo('/page/products')">
        <i class="pi pi-shopping-bag"></i>
        <span>Thêm sản phẩm</span>
      </button>
      <button class="quick-action-btn" (click)="navigateTo('/page/debit')">
        <i class="pi pi-user-plus"></i>
        <span>Thêm khách hàng</span>
      </button>
      <button class="quick-action-btn" (click)="navigateTo('/page/report')">
        <i class="pi pi-file-pdf"></i>
        <span>Xem báo cáo</span>
      </button>
    </div>
  </div>

  <p-toast position="top-right" />
</div>
