<div class="debit-dialog">
  <div class="dialog-header">
    <div class="header-content">
      <i class="pi pi-book"></i>
      <h2>Ghi nợ khách hàng</h2>
    </div>
    <button class="close-btn" (click)="closeDialog()">
      <i class="pi pi-times"></i>
    </button>
  </div>

  <div class="dialog-body">
    <div class="total-badge">
      <div class="badge-label">Tổng tiền cần thanh toán</div>
      <div class="badge-amount">{{ formatCurrency(totalAmount) }}</div>
    </div>

    <form [formGroup]="debitForm">
      <div class="form-group">
        <label class="form-label">
          Tên khách hàng
          <span class="required">*</span>
        </label>
        <div class="input-wrapper">
          <i class="pi pi-user"></i>
          <input
            type="text"
            class="form-input"
            formControlName="customerName"
            placeholder="Nhập tên khách hàng"
            [class.error]="isFieldInvalid('customerName')"
          />
        </div>
        @if (isFieldInvalid('customerName')) {
          <span class="error-text">
            <i class="pi pi-exclamation-circle"></i>
            Vui lòng nhập tên khách hàng (tối thiểu 2 ký tự)
          </span>
        }
      </div>

      <div class="form-group">
        <label class="form-label">
          Số điện thoại
          <span class="required">*</span>
        </label>
        <div class="input-wrapper">
          <i class="pi pi-phone"></i>
          <input
            type="tel"
            class="form-input"
            formControlName="phoneNumber"
            placeholder="Nhập số điện thoại"
            maxlength="11"
            [class.error]="isFieldInvalid('phoneNumber')"
          />
        </div>
        @if (isFieldInvalid('phoneNumber')) {
          <span class="error-text">
            <i class="pi pi-exclamation-circle"></i>
            Số điện thoại không hợp lệ (10-11 số)
          </span>
        }
        @if (customerExists && !isFieldInvalid('phoneNumber')) {
          <span class="success-text">
            <i class="pi pi-check-circle"></i>
            Tìm thấy khách hàng trong hệ thống
          </span>
        }
      </div>

      <div class="form-group">
        <label class="form-label">
          Địa chỉ
          <span class="optional">(Tùy chọn)</span>
        </label>
        <div class="input-wrapper">
          <i class="pi pi-map-marker"></i>
          <input
            type="text"
            class="form-input"
            formControlName="address"
            placeholder="Nhập địa chỉ khách hàng"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          Số tiền ghi nợ
          <span class="required">*</span>
        </label>
        <div class="price-wrapper">
          <i class="pi pi-money-bill"></i>
          <input
            type="number"
            class="form-input price-input"
            formControlName="debitAmount"
            placeholder="0"
            min="0"
            [max]="totalAmount"
            step="1000"
            [class.error]="isFieldInvalid('debitAmount')"
          />
          <span class="currency">₫</span>
        </div>
        <button type="button" class="quick-btn full-debt" (click)="setDebitAmount(totalAmount)">
          <i class="pi pi-dollar"></i>
          Ghi nợ toàn bộ
        </button>
        @if (isFieldInvalid('debitAmount')) {
          <span class="error-text">
            <i class="pi pi-exclamation-circle"></i>
            @if (debitForm.get('debitAmount')?.hasError('required')) {
              Vui lòng nhập số tiền ghi nợ
            }
            @if (debitForm.get('debitAmount')?.hasError('min')) {
              Số tiền phải lớn hơn 0
            }
            @if (debitForm.get('debitAmount')?.hasError('max')) {
              Số tiền không được vượt quá tổng đơn hàng
            }
          </span>
        }
      </div>

      <div class="form-group">
        <label class="form-label">Số tiền đã trả</label>
        <div class="price-wrapper readonly">
          <i class="pi pi-wallet"></i>
          <input
            type="text"
            class="form-input price-input"
            [value]="formatCurrency(paidAmount)"
            readonly
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          Ngày hẹn trả
          <span class="optional">(Tùy chọn)</span>
        </label>
        <div class="input-wrapper">
          <i class="pi pi-calendar"></i>
          <input
            type="date"
            class="form-input"
            formControlName="dueDate"
            [min]="minDate"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          Ghi chú
          <span class="optional">(Tùy chọn)</span>
        </label>
        <textarea
          class="form-input textarea"
          formControlName="note"
          placeholder="Thêm ghi chú về khoản nợ này..."
          rows="3"
        ></textarea>
      </div>
    </form>

    <div class="summary">
      <div class="summary-header">
        <i class="pi pi-file-check"></i>
        <span>Tổng kết</span>
      </div>
      <div class="summary-row">
        <span class="label">
          <i class="pi pi-shopping-cart"></i>
          Tổng đơn hàng:
        </span>
        <span class="value">{{ formatCurrency(totalAmount) }}</span>
      </div>
      <div class="summary-row highlight">
        <span class="label">
          <i class="pi pi-book"></i>
          Số tiền ghi nợ:
        </span>
        <span class="value debt">{{ formatCurrency(debitForm.get('debitAmount')?.value || 0) }}</span>
      </div>
      <div class="summary-row">
        <span class="label">
          <i class="pi pi-wallet"></i>
          Đã thanh toán:
        </span>
        <span class="value paid">{{ formatCurrency(paidAmount) }}</span>
      </div>
    </div>
  </div>

  <div class="dialog-footer">
    <button class="btn btn-cancel" (click)="closeDialog()">
      <i class="pi pi-times"></i>
      <span>Hủy</span>
    </button>
    <button
      class="btn btn-save"
      [disabled]="!debitForm.valid || isLoading"
      (click)="saveDebit()"
    >
      <i class="pi" [class.pi-spin]="isLoading" [class.pi-spinner]="isLoading" [class.pi-check]="!isLoading"></i>
      <span>{{ isLoading ? 'Đang xử lý...' : 'Xác nhận ghi nợ' }}</span>
    </button>
  </div>
</div>
